<%
# BigBlueButton open source conferencing system - http://www.bigbluebutton.org/.
# Copyright (c) 2018 BigBlueButton Inc. and by respective authors (see below).
# This program is free software; you can redistribute it and/or modify it under the
# terms of the GNU Lesser General Public License as published by the Free Software
# Foundation; either version 3.0 of the License, or (at your option) any later
# version.
#
# BigBlueButton is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
# You should have received a copy of the GNU Lesser General Public License along
# with BigBlueButton; if not, see <http://www.gnu.org/licenses/>.
%>

<div data-path="<%= update_settings_path(room) %>" data-room-access-code="<%= room.access_code %>" class="card room-block">
  <div class="card-body p-0">
    <% if @current_user.role.name === 'Single Brand' && role_custom_branding(@current_user.role) %>
      <% bc = @plan_settings['primaryColor'] %>
    <% elsif ((@current_user.role.name === 'Organization' || @current_user.role.name === 'Multi Brand' || @current_user.role.name === 'Admin') && role_custom_branding(@current_user.role)) %>
      <% bc = room.primary_color || @room_settings['primaryColor'] %>
   <% else %>
      <% bc = user_color %>
   <% end %>
    <table class="table table-hover table-vcenter text-wrap table-no-border m-0">
      <tbody class="no-border-top">
        <td class="py-5">
          <span class="stamp stamp-md bg-primary" style="background:<%=bc %> !important">
            <% if room == current_user.main_room %>
              <i class="fas fa-home"></i>
            <% else %>
              <i class="fas fa-chalkboard-teacher" ></i>
            <% end %>
          </span>
        </td>
        <td>
          <div>
            <h4 contenteditable="false" class="m-0 force-text-normal room-name-text" ><%= room.name %></h4>
            <h4 class="m-0 force-text-normal room-primarycolor-text d-none" ><%= bc %></h4>
          </div>
          <div style="display: none">
            <input class="form-control input-sm w-100 h-4 room-name-editable" value="<%= room.name %>">
          </div>
          <div class="small text-muted">
            <% if room.sessions > 0 %>
              <i><%= t("room.last_session", on: ':', session: recording_date(room.last_session)) %></i>
            <% else %>
              <i><%= t("room.no_sessions") %></i>
            <% end %>
          </div>
        </td>
        <td class="text-right">
          <div class="item-action dropdown" data-display="static">
            <a href="#" data-toggle="dropdown" data-display="static" class="icon">
              <i class="fas fa-ellipsis-v px-4"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-right dropdown-menu-md-left">
              <a href="" data-toggle="modal" data-target="#createRoomModal" class="update-room dropdown-item" data-settings-path="<%= room_settings_path(room) %>">
                <i class="dropdown-icon fas fa-cog"></i> <%= t("room.settings") %>
              </a>
              <% if preupload_allowed? %>
                <a href="" data-toggle="modal" data-target="#preuploadPresentationModal" class="preupload-room dropdown-item" data-path="<%= preupload_presentation_path(room) %>" data-settings-path="<%= current_presentation_path(room) %>"  data-remove="<%= remove_presentation_path(room) %>">
                  <i class="dropdown-icon fas fa-file-upload"></i> <%= t("room.add_presentation") %>
                </a>
              <% end %>
              <% if shared_access_allowed %>
                <a href="" data-toggle="modal" data-target="#shareRoomModal" class="share-room dropdown-item" data-path="<%= room_shared_access_path(room) %>" data-users-path="<%= room_shared_users_path(room) %>">
                  <i class="dropdown-icon fas fa-users"></i> <%= t("room.share") %>
                </a>
              <% end %>
              <% unless room == current_user.main_room %>
                <a href="" data-toggle="modal" data-target="#deleteRoomModal" data-path="<%= room_path(room) %>" data-name="<%= room.name %>" class="delete-room dropdown-item">
                  <i class="dropdown-icon far fa-trash-alt"></i> <%= t("delete") %>
                </a>
              <% end %>
            </div>
          </div>
        </td>
      </tbody>
    </table>
    <% if r_status(room.bbb_id) %>
        <span class="position-absolute rounded text-white" style="background: #E64980;
        border-radius: 2px;padding: 2px 6px;right:5px;top:5px;"> LIVE </span>
    <% end %>
    <% att = get_Attendees(room.bbb_id) %>
    <% if att['data'] %>  
    <div class="class-cover-image" style="border-top:1px solid rgba(0, 40, 100, 0.12)">
    <div class="align-items-center justify-content-between position-relative attendee-list p-6" style="background:<%= bc %>">
      <% if att['data'].to_a.length <= 11 %>
        <% att['data'].to_a.each do |a| %>  
          <% if a['role'] == 'MODERATOR' %>
            <span data-toggle="tooltip" data-placement="bottom" title="<%= a['name'] %>" class="position-absolute rounded-circle border-white border text-white text-center overflow-hidden" 
            style="width:50px;height:50px;line-height:50px;top:-17px;left:calc(50% - 25px);background:<%= bc %>">
              <% if a['picture'] != "" %>
                <img src="<%= a['picture'] %>" />
              <% else %>
                <%= a['name'].chr %>
              <% end %>
            </span>
          <% else %>
            <span data-toggle="tooltip" data-placement="bottom" title="<%= a['name'] %>" class="d-inline-block position-relative rounded-circle border-white border text-white text-center my-3 left-overlap overflow-hidden" 
              style="background:<%= bc %>">
              <% if a['picture'] != "" %>
                <img src="<%= a['picture'] %>" />
              <% else %>
                <%= a['name'][0,2].upcase %>
              <% end %>
            </span>
          <% end %>
        <% end %>
      <% else %>
          <% a = att['data'].to_a.take(10) %>
          <% a.each do |a| %>
            <% if a['role'] == 'MODERATOR' %>
              <span data-toggle="tooltip" data-placement="bottom" title="<%= a['name'] %>" class="position-absolute rounded-circle border-white border text-white text-center overflow-hidden" 
              style="width:50px;height:50px;line-height:50px;top:-17px;left:calc(50% - 25px);background:<%= bc %>">
                <% if a['picture'] != "" %>
                  <img src="<%= a['picture'] %>" />
                <% else %>
                  <%= a['name'].chr %>
                <% end %>
              </span>
            <% else %>
              <span data-toggle="tooltip" data-placement="bottom" title="<%= a['name'] %>" class="d-inline-block position-relative rounded-circle border-white border text-white text-center my-3 left-overlap overflow-hidden" 
                style="background:<%= bc %>">
                <% if a['picture'] != "" %>
                  <img src="<%= a['picture'] %>" />
                <% else %>
                  <%= a['name'].to_sym %>
                <% end %>
              </span>
            <% end %>
          <% end %>
          <a href="#" class="d-inline-block position-relative rounded-circle border-secondary border text-white text-center text-bold mt-3 left-overlap" 
          style="background:<%= bc %>"
          data-toggle="modal" data-target="#roomAttendeesListModal_<%= room.bbb_id %>" >
         
           +<%= att['data'].to_a.length - 10%>
          </a>
          <%= render "shared/modals/list_attendees_modal", attendees: att, id: room.bbb_id %>
      <% end %>
    </div>
    </div>
    <% else %>
    <div class="small text-muted text-center py-7" style="border-top:1px solid rgba(0, 40, 100, 0.12)">
      <i><%= t("room.no_sessions") %></i>
    </div>
    <% end %>
  </div>
</div>